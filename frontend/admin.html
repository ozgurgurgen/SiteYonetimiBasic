<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Site Aidat Admin Paneli</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f8f9fa; 
      color: #333;
      padding: 10px;
    }
    
    @media (min-width: 768px) {
      body { padding: 20px; }
    }
    
    .admin-header {
      background: linear-gradient(135deg, #2c5aa0 0%, #1e3f73 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    
    @media (min-width: 768px) {
      .admin-header {
        padding: 20px;
        margin-bottom: 20px;
        flex-direction: row;
        justify-content: space-between;
        gap: 0;
      }
    }
    
    .admin-title {
      font-size: 18px;
      font-weight: bold;
    }
    
    @media (min-width: 768px) {
      .admin-title {
        font-size: 24px;
      }
    }
    
    .back-link {
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 5px;
      text-decoration: none;
      transition: background 0.3s;
      font-size: 14px;
    }
    
    @media (min-width: 768px) {
      .back-link {
        padding: 10px 20px;
        font-size: 16px;
      }
    }
    
    .back-link:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .controls-section {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    @media (min-width: 768px) {
      .controls-section {
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }
    }
    
    @media (min-width: 1024px) {
      .controls-section {
        grid-template-columns: 1fr 1fr 2fr;
      }
    }
    
    .control-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    @media (min-width: 768px) {
      .control-card {
        padding: 20px;
      }
    }
    
    .control-card h3 {
      color: #2c5aa0;
      margin-bottom: 15px;
      font-size: 14px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 5px;
    }
    
    @media (min-width: 768px) {
      .control-card h3 {
        font-size: 16px;
      }
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    @media (min-width: 768px) {
      .form-group {
        margin-bottom: 18px;
      }
    }
    
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 13px;
      color: #2c5aa0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    @media (min-width: 768px) {
      .form-group label {
        font-size: 14px;
        margin-bottom: 8px;
      }
    }
    
    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: #fafbfc;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #4472c4;
      background: white;
      box-shadow: 0 0 0 3px rgba(68, 114, 196, 0.1);
    }
    
    @media (min-width: 768px) {
      .form-group input {
        padding: 12px 15px;
        font-size: 15px;
      }
    }
    
    .btn {
      background: linear-gradient(135deg, #4472c4 0%, #2c5aa0 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 2px 4px rgba(68, 114, 196, 0.2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    @media (min-width: 768px) {
      .btn {
        padding: 12px 25px;
        font-size: 14px;
        width: auto;
        border-radius: 8px;
      }
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(68, 114, 196, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #70ad47 0%, #548235 100%);
      box-shadow: 0 2px 4px rgba(112, 173, 71, 0.2);
    }
    
    .btn-success:hover {
      box-shadow: 0 4px 12px rgba(112, 173, 71, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      padding: 6px 10px;
      font-size: 12px;
      width: auto;
      min-width: 35px;
      box-shadow: 0 2px 4px rgba(231, 76, 60, 0.2);
    }
    
    .btn-danger:hover {
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }
    
    .btn-success:hover {
      background: #548235;
    }
    
    .btn-danger {
      background: #e74c3c;
    }
    
    .btn-danger:hover {
      background: #c0392b;
    }
    
    .data-table {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      border: 1px solid #e1e5e9;
    }
    
    @media (min-width: 768px) {
      .data-table {
        margin-bottom: 25px;
        border-radius: 12px;
      }
    }
    
    .table-header {
      background: linear-gradient(135deg, #2c5aa0 0%, #4472c4 100%);
      color: white;
      padding: 15px 20px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 4px rgba(44, 90, 160, 0.2);
    }
    
    @media (min-width: 768px) {
      .table-header {
        padding: 18px 25px;
        font-size: 18px;
      }
    }
    
    .table-content {
      padding: 20px;
      overflow-x: auto;
      background: #fafbfc;
    }
    
    @media (min-width: 768px) {
      .table-content {
        padding: 25px;
      }
    }
    
    .member-table {
      width: 100%;
      min-width: 600px;
      border-collapse: collapse;
    }
    
    @media (min-width: 768px) {
      .member-table {
        min-width: auto;
      }
    }
    
    .member-table th,
    .member-table td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
      font-size: 12px;
    }
    
    @media (min-width: 768px) {
      .member-table th,
      .member-table td {
        padding: 10px;
        font-size: 14px;
      }
    }
    
    .member-table th {
      background: #f8f9fa;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .member-table tbody tr:hover {
      background: #f8f9fa;
    }
    
    .payment-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 1px;
      margin: 8px 0;
    }
    
    @media (min-width: 768px) {
      .payment-grid {
        grid-template-columns: repeat(12, 1fr);
        gap: 2px;
        margin: 10px 0;
      }
    }
    
    .payment-cell {
      padding: 3px;
      text-align: center;
      font-size: 9px;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    @media (min-width: 768px) {
      .payment-cell {
        padding: 5px;
        font-size: 10px;
      }
    }
    
    .payment-cell.paid {
      background: #70ad47;
      color: white;
    }
    
    .payment-cell.unpaid {
      background: #fff2cc;
      color: #7f6000;
    }
    
    .payment-cell:hover {
      transform: scale(1.1);
    }
    
    .expense-row {
      display: grid;
      grid-template-columns: 80px 70px 1fr 80px 50px;
      gap: 6px;
      padding: 8px;
      border-bottom: 1px solid #e9ecef;
      align-items: center;
      transition: all 0.2s ease;
      border-radius: 4px;
      margin-bottom: 2px;
      font-size: 12px;
    }
    
    @media (min-width: 768px) {
      .expense-row {
        grid-template-columns: 110px 130px 2fr 120px 80px;
        gap: 15px;
        padding: 15px;
        font-size: 14px;
      }
    }
    
    .expense-header {
      background: linear-gradient(135deg, #2c5aa0 0%, #4472c4 100%) !important;
      color: white !important;
      font-weight: bold;
      margin-bottom: 8px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(44, 90, 160, 0.2);
    }
    
    .expense-item {
      background: #fafbfc;
      border: 1px solid #e1e5e9;
    }
    
    .expense-item:hover {
      background: #f0f3f7;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      transform: translateY(-1px);
    }
    
    .expense-description {
      font-style: normal;
      color: inherit;
      font-size: 11px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    @media (min-width: 768px) {
      .expense-description {
        font-size: 14px;
        white-space: normal;
      }
    }
    
    .expense-amount {
      text-align: right;
      font-weight: 600;
      color: #e74c3c;
      font-size: 11px;
    }
    
    @media (min-width: 768px) {
      .expense-amount {
        font-size: 14px;
      }
    }
    
    .expense-header .expense-amount {
      color: white;
      text-align: center;
    }
    
    @media (min-width: 768px) {
      .expense-header .expense-amount {
        text-align: right;
      }
    }
    
    .expense-action {
      text-align: center;
    }
    
    .expense-date,
    .expense-type {
      font-size: 11px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    @media (min-width: 768px) {
      .expense-date,
      .expense-type {
        font-size: 14px;
        white-space: normal;
      }
    }
    
    .expense-action .btn {
      padding: 4px 8px;
      font-size: 10px;
      min-width: 28px;
    }
    
    @media (min-width: 768px) {
      .expense-action .btn {
        padding: 6px 10px;
        font-size: 12px;
        min-width: 35px;
      }
    }
    
    .status-bar {
      position: fixed;
      top: 15px;
      right: 15px;
      padding: 8px 15px;
      background: #70ad47;
      color: white;
      border-radius: 5px;
      display: none;
      font-size: 12px;
      z-index: 1000;
    }
    
    @media (min-width: 768px) {
      .status-bar {
        top: 20px;
        right: 20px;
        padding: 10px 20px;
        font-size: 14px;
      }
    }
    
    .status-bar.error {
      background: #e74c3c;
    }
    .login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .login-form {
      background: white;
      padding: 30px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      text-align: center;
      width: 90%;
      max-width: 400px;
    }
    
    @media (min-width: 768px) {
      .login-form {
        padding: 40px;
        min-width: 300px;
        width: auto;
      }
    }
    
    .login-title {
      color: #2c5aa0;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    
    @media (min-width: 768px) {
      .login-title {
        font-size: 24px;
      }
    }
    
    .login-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 15px;
      text-align: center;
      transition: border-color 0.3s;
    }
    
    @media (min-width: 768px) {
      .login-input {
        padding: 12px;
        font-size: 16px;
        margin-bottom: 20px;
      }
    }
    
    .login-input:focus {
      outline: none;
      border-color: #4472c4;
    }
    
    .login-btn {
      background: #2c5aa0;
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      transition: background 0.3s;
    }
    
    @media (min-width: 768px) {
      .login-btn {
        padding: 12px 30px;
        font-size: 16px;
      }
    }
    
    .login-btn:hover {
      background: #1e3f73;
    }
    
    .login-error {
      color: #e74c3c;
      margin-top: 10px;
      font-size: 14px;
    }
    
    .admin-content {
      display: none;
    }
    
    .admin-content.authenticated {
      display: block;
    }
  </style>
</head>
<body>
  <div id="loginOverlay" class="login-overlay">
    <div class="login-form">
      <div class="login-title">üîê Admin Giri≈üi</div>
      <input type="password" id="adminPassword" class="login-input" placeholder="Admin ≈üifresi giriniz" />
      <button class="login-btn" onclick="checkPassword()">Giri≈ü Yap</button>
      <div id="loginError" class="login-error"></div>
    </div>
  </div>

  <div id="adminContent" class="admin-content">
  <div class="admin-header">
    <div class="admin-title">üë®‚Äçüíº Admin Paneli - YAZIRAY Sƒ∞TESƒ∞ B BLOK</div>
    <a href="index.html" class="back-link">‚Üê Ana Sayfa</a>
  </div>

  <div class="status-bar" id="statusBar"></div>

  <div class="controls-section">
    <div class="control-card">
      <h3>‚öôÔ∏è Sistem Ayarlarƒ±</h3>
      <div class="form-group">
        <label>Aylƒ±k Aidat (‚Ç∫)</label>
        <input type="number" id="monthlyFee" value="100">
      </div>
      <div class="form-group">
        <label>√ñnceki Yƒ±l Devir (‚Ç∫)</label>
        <input type="number" id="previousCarry" value="0" step="0.01">
      </div>
      <div class="form-group">
        <label>Yƒ±l</label>
        <input type="number" id="setYear" value="2025">
      </div>
      <button class="btn" id="saveSettings">üíæ Kaydet</button>
    </div>
    
    <div class="control-card">
      <h3>üë• Yeni √úye Ekle</h3>
      <div class="form-group">
        <label>√úye Adƒ±</label>
        <input type="text" id="newMemberName" placeholder="ƒ∞sim giriniz">
      </div>
      <button class="btn btn-success" id="addMember">‚ûï √úye Ekle</button>
    </div>
    
    <div class="control-card">
      <h3>üí∏ Yeni Gider Ekle</h3>
      <div class="form-group">
        <label>Tarih</label>
        <input type="date" id="expenseDate">
      </div>
      <div class="form-group">
        <label>Gider T√ºr√º</label>
        <input type="text" id="expenseType" placeholder="Temizlik, Bakƒ±m vb.">
      </div>
      <div class="form-group">
        <label>A√ßƒ±klama</label>
        <input type="text" id="expenseDesc" placeholder="Detaylƒ± a√ßƒ±klama">
      </div>
      <div class="form-group">
        <label>Tutar (‚Ç∫)</label>
        <input type="number" id="expenseAmount" step="0.01" placeholder="0.00">
      </div>
      <button class="btn btn-success" id="addExpense">üí∞ Gider Ekle</button>
    </div>
  </div>

  <div class="data-table">
    <div class="table-header">üë• √úye Y√∂netimi ve √ñdeme Takibi</div>
    <div class="table-content">
      <table class="member-table">
        <thead>
          <tr>
            <th>√úye Adƒ±</th>
            <th>√ñdeme Durumu (Aylƒ±k)</th>
            <th>Toplam</th>
            <th>ƒ∞≈ülem</th>
          </tr>
        </thead>
        <tbody id="membersTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <div class="data-table">
    <div class="table-header">üí∏ Gider Y√∂netimi</div>
    <div class="table-content" id="expensesContainer">
    </div>
  </div>
  
  </div> <!-- admin-content end -->

<script>
// Admin ≈üifre kontrol√º
const ADMIN_PASSWORD = 'admin123'; // ≈ûifreyi burada deƒüi≈ütirebilirsiniz

function checkPassword() {
  const password = document.getElementById('adminPassword').value;
  const errorDiv = document.getElementById('loginError');
  
  if (password === ADMIN_PASSWORD) {
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('adminContent').classList.add('authenticated');
    sessionStorage.setItem('adminAuthenticated', 'true');
    errorDiv.textContent = '';
  } else {
    errorDiv.textContent = 'Hatalƒ± ≈üifre! Tekrar deneyin.';
    document.getElementById('adminPassword').value = '';
  }
}

// Sayfa y√ºklendiƒüinde oturum kontrol√º
window.onload = function() {
  if (sessionStorage.getItem('adminAuthenticated') === 'true') {
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('adminContent').classList.add('authenticated');
  }
}

// Enter tu≈üu ile giri≈ü
document.getElementById('adminPassword').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    checkPassword();
  }
});

// API URL - automatically detects environment
const API = window.location.hostname === 'localhost' 
  ? 'http://localhost:3000/api' 
  : '/api';
let settings = {};
let members = [];
let expenses = [];

function showStatus(message, isError = false) {
  const statusBar = document.getElementById('statusBar');
  statusBar.textContent = message;
  statusBar.className = isError ? 'status-bar error' : 'status-bar';
  statusBar.style.display = 'block';
  setTimeout(() => {
    statusBar.style.display = 'none';
  }, 3000);
}

async function fetchAll(){
  try {
    const settingsResponse = await fetch(API + '/settings');
    const membersResponse = await fetch(API + '/members');
    const expensesResponse = await fetch(API + '/expenses');
    
    if (!settingsResponse.ok) {
      throw new Error(`Settings API error: ${settingsResponse.status}`);
    }
    if (!membersResponse.ok) {
      throw new Error(`Members API error: ${membersResponse.status}`);
    }
    if (!expensesResponse.ok) {
      throw new Error(`Expenses API error: ${expensesResponse.status}`);
    }
    
    settings = await settingsResponse.json();
    const membersData = await membersResponse.json();
    const expensesData = await expensesResponse.json();
    
    // Ensure members is an array
    members = Array.isArray(membersData) ? membersData : [];
    expenses = Array.isArray(expensesData) ? expensesData : [];
    
    // Database field name compatibility
    if (settings.monthly_fee && !settings.monthlyFee) {
      settings.monthlyFee = settings.monthly_fee;
    }
    if (settings.previous_carry_over !== undefined && !settings.previousCarryOver) {
      settings.previousCarryOver = settings.previous_carry_over;
    }
    
    renderAll();
    showStatus('‚úÖ Veriler y√ºklendi');
  } catch (e) {
    console.error('API baƒülantƒ± hatasƒ±:', e);
    showStatus('‚ùå Backend baƒülantƒ± hatasƒ± - Demo veri kullanƒ±lƒ±yor', true);
    loadDemoData();
  }
}

function loadDemoData() {
  settings = { monthlyFee: 100, previousCarryOver: 188.50, year: 2025 };
  members = [
    {id: '1', name: 'ƒ∞smail', payments: {'2025-08': {paid: true, amount: 100}}},
    {id: '2', name: 'Ali', payments: {'2025-08': {paid: true, amount: 100}, '2025-09': {paid: true, amount: 100}}},
    {id: '3', name: '√ñzg√ºr', payments: {'2025-08': {paid: true, amount: 100}}},
    {id: '4', name: 'ƒ∞smail', payments: {'2025-08': {paid: true, amount: 100}, '2025-09': {paid: true, amount: 100}}},
    {id: '5', name: 'Mehmet', payments: {}},
    {id: '6', name: 'Murat', payments: {}}
  ];
  expenses = [
    {id: '1', date: '2025-08-11', type: 'Temizlik', description: 'Temizlik kimyasallarƒ± ve vileda (ƒ∞smail 4)', amount: 811.50}
  ];
  renderAll();
}

function getMonths(){
  return Array.from({length:12}, (_,i)=> `${settings.year}-${String(i+1).padStart(2,'0')}`);
}

function monthLabel(ym){
  const m = ym.split('-')[1];
  return ['O','≈û','M','N','M','H','T','A','E','E','K','A'][Number(m)-1];
}

function getMonthlyFeeForMonth(yearMonth) {
  const feeHistory = settings.feeHistory || [];
  if (feeHistory.length === 0) {
    return settings.monthlyFee || 100;
  }
  
  // Tarihi YYYY-MM formatƒ±na √ßevir
  const targetDate = yearMonth + '-01';
  
  // Ge√ßmi≈üe doƒüru ara, o ay i√ßin ge√ßerli olan tutarƒ± bul
  let applicableFee = feeHistory[0].amount;
  
  for (const fee of feeHistory) {
    if (fee.startDate <= targetDate) {
      applicableFee = fee.amount;
    } else {
      break;
    }
  }
  
  return applicableFee;
}

function renderAll() {
  document.getElementById('monthlyFee').value = settings.monthlyFee;
  document.getElementById('previousCarry').value = settings.previousCarryOver;
  document.getElementById('setYear').value = settings.year;
  renderMembers();
  renderExpenses();
}

function renderMembers(){
  const months = getMonths();
  const tbody = document.getElementById('membersTableBody');
  let html = '';
  
  members.forEach(member => {
    const memberTotal = months.reduce((sum, month) => {
      const payment = member.payments?.[month];
      if (payment && typeof payment === 'object' && payment.amount !== undefined) {
        return sum + payment.amount;
      } else if (payment === true) {
        return sum + getMonthlyFeeForMonth(month);
      }
      return sum;
    }, 0);
    
    html += '<tr>';
    html += `<td><strong>${member.name}</strong></td>`;
    html += '<td><div class="payment-grid">';
    
    months.forEach(month => {
      const payment = member.payments?.[month];
      const paid = payment && (payment.paid === true || payment === true);
      const cellClass = paid ? 'payment-cell paid' : 'payment-cell unpaid';
      html += `<div class="${cellClass}" data-member="${member.id}" data-ym="${month}" title="${monthLabel(month)}">${monthLabel(month)}</div>`;
    });
    
    html += '</div></td>';
    html += `<td><strong>‚Ç∫ ${memberTotal.toFixed(2)}</strong></td>`;
    html += `<td><button class="btn btn-danger" data-del="${member.id}">üóëÔ∏è Sil</button></td>`;
    html += '</tr>';
  });
  
  tbody.innerHTML = html;
}

function renderExpenses(){
  const container = document.getElementById('expensesContainer');
  let html = '<div class="expense-row expense-header">';
  html += '<div>Tarih</div><div>T√ºr</div><div>A√ßƒ±klama</div><div>Tutar</div><div>ƒ∞≈ülem</div>';
  html += '</div>';
  
  expenses.forEach(expense => {
    html += '<div class="expense-row expense-item">';
    html += `<div class="expense-date">${expense.date}</div>`;
    html += `<div class="expense-type">${expense.type || '-'}</div>`;
    html += `<div class="expense-description">${expense.description || '-'}</div>`;
    html += `<div class="expense-amount">‚Ç∫ ${expense.amount.toFixed(2)}</div>`;
    html += `<div class="expense-action"><button class="btn btn-danger" data-expdel="${expense.id}">üóëÔ∏è</button></div>`;
    html += '</div>';
  });
  
  container.innerHTML = html;
}

// Event Handlers
document.getElementById('saveSettings').onclick = async () => {
  try {
    settings.monthlyFee = parseFloat(document.getElementById('monthlyFee').value) || 100;
    settings.previousCarryOver = parseFloat(document.getElementById('previousCarry').value) || 0;
    settings.year = parseInt(document.getElementById('setYear').value) || 2025;
    
    await fetch(API + '/settings', {
      method:'PUT', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(settings)
    });
    showStatus('‚úÖ Ayarlar kaydedildi');
    renderAll();
  } catch(e) {
    showStatus('‚ùå Ayarlar kaydedilemedi', true);
    renderAll(); // Local update
  }
};

document.getElementById('addMember').onclick = async () => {
  const name = document.getElementById('newMemberName').value.trim();
  if(!name) {
    showStatus('‚ùå √úye adƒ± bo≈ü olamaz', true);
    return;
  }
  
  try {
    await fetch(API + '/members', {
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify({ name })
    });
    document.getElementById('newMemberName').value = '';
    showStatus(`‚úÖ ${name} eklendi`);
    await fetchAll();
  } catch(e) {
    // Local add
    members.push({id: Date.now().toString(), name, payments: {}});
    document.getElementById('newMemberName').value = '';
    showStatus(`‚úÖ ${name} eklendi (yerel)`);
    renderAll();
  }
};

document.getElementById('addExpense').onclick = async () => {
  const date = document.getElementById('expenseDate').value;
  const type = document.getElementById('expenseType').value;
  const description = document.getElementById('expenseDesc').value;
  const amount = parseFloat(document.getElementById('expenseAmount').value);
  
  if(!date || !amount) {
    showStatus('‚ùå Tarih ve tutar zorunlu', true);
    return;
  }
  
  try {
    await fetch(API + '/expenses', {
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify({ date, type, description, amount })
    });
    document.getElementById('expenseDate').value = '';
    document.getElementById('expenseType').value = '';
    document.getElementById('expenseDesc').value = '';
    document.getElementById('expenseAmount').value = '';
    showStatus('‚úÖ Gider eklendi');
    await fetchAll();
  } catch(e) {
    // Local add
    expenses.push({id: Date.now().toString(), date, type, description, amount});
    document.getElementById('expenseDate').value = '';
    document.getElementById('expenseType').value = '';
    document.getElementById('expenseDesc').value = '';
    document.getElementById('expenseAmount').value = '';
    showStatus('‚úÖ Gider eklendi (yerel)');
    renderAll();
  }
};

// Delegated Events
document.getElementById('membersTableBody').addEventListener('click', async e => {
  // Payment toggle
  if(e.target.classList.contains('payment-cell')) {
    const memberId = e.target.dataset.member;
    const yearMonth = e.target.dataset.ym;
    
    try {
      await fetch(`${API}/members/${memberId}/payments/${yearMonth}/toggle`, {method:'POST'});
      showStatus('‚úÖ √ñdeme durumu g√ºncellendi');
      await fetchAll();
    } catch(ex) {
      // Local toggle - yeni payment sistemi
      const member = members.find(m => m.id === memberId);
      if(member) {
        if(!member.payments) member.payments = {};
        
        if (member.payments[yearMonth]) {
          // √ñdeme varsa kaldƒ±r
          delete member.payments[yearMonth];
        } else {
          // O ay i√ßin ge√ßerli olan aidat tutarƒ±yla ekle
          const monthlyFee = getMonthlyFeeForMonth(yearMonth);
          member.payments[yearMonth] = {
            paid: true,
            amount: monthlyFee,
            paidAt: new Date().toISOString()
          };
        }
        
        showStatus('‚úÖ √ñdeme durumu g√ºncellendi (yerel)');
        renderAll();
      }
    }
  }
  
  // Delete member
  if(e.target.dataset.del) {
    if(confirm('Bu √ºyeyi silmek istediƒüinizden emin misiniz?')) {
      try {
        await fetch(`${API}/members/${e.target.dataset.del}`, {method:'DELETE'});
        showStatus('‚úÖ √úye silindi');
        await fetchAll();
      } catch(ex) {
        members = members.filter(m => m.id !== e.target.dataset.del);
        showStatus('‚úÖ √úye silindi (yerel)');
        renderAll();
      }
    }
  }
});

document.getElementById('expensesContainer').addEventListener('click', async e => {
  if(e.target.dataset.expdel) {
    if(confirm('Bu gideri silmek istediƒüinizden emin misiniz?')) {
      try {
        await fetch(`${API}/expenses/${e.target.dataset.expdel}`, {method:'DELETE'});
        showStatus('‚úÖ Gider silindi');
        await fetchAll();
      } catch(ex) {
        expenses = expenses.filter(exp => exp.id !== e.target.dataset.expdel);
        showStatus('‚úÖ Gider silindi (yerel)');
        renderAll();
      }
    }
  }
});

// Set today's date as default
document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];

fetchAll();
</script>
</body>
</html>
